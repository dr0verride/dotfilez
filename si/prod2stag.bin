#!/bin/bash

usage() {
  echo "Usage: $1 <user> <schema>"
}

if [ -z "$1" ]; then
  echo "Must supply a user"
  usage $0
  exit 1
fi

if [ -z "$2" ]; then
  echo "Must supply a schema"
  usage $0
  exit 1
fi

user="$1"
schema="$2"
timestamp=`date +"%Y%m%d%H%M%S"`

dump="${schema}-production-${timestamp}.dump"

echo "Dumping schema $schema as $user"
if ! pg_dump -h rds -U $user -n $schema -F d -f $dump -j 2 searchinfluence; then
  echo "PG Dump failed"
  exit 1
fi

echo "Truncating data from schema $schema"
psql -h rds-staging -U administrator -d searchinfluence -c "select utils.truncate_schema('$schema')" > /dev/null

echo "Restoring data to schema $schema as $user"
pg_restore -h rds-staging -U $user -n $schema -j 2 --data-only -d searchinfluence $dump

rm -rf $dump
